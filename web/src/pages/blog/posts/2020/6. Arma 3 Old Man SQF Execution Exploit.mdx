---
title: Arma 3 “Old Man” SQF Execution Exploit 
description: |
    With the "Old Man" update out now, I decided to take another
    look at the Functions and UI scripts to see what fixes they implemented...
slug: arma-3-old-man-sqf-execution-exploit
---

# Arma 3 “Old Man” SQF Execution Exploit

With the "Old Man" update out now, I decided to take another look at the Functions and UI scripts to see what fixes they implemented, and to look for a new exploit for SQF execution.

To my surprise, I was greeted with BIS_fnc_parseNumberSafe. This neat little function is a "fix" for their previously broken BIS_fnc_parseNumber. They implemented a smart little trick to prevent unwanted code execution while parsing string types.

Just to refresh you on BIS_fnc_parseNumber &amp; why it was truly awful. Here is a small snippet from it:
<a href="https://ss.lystic.zip/Legacy/I5jbvSDK/yQ3GoGDB1Ario62b.png" target="_blank" rel="noopener noreferrer"><img class="alignnone size-medium" src="https://ss.lystic.zip/Legacy/I5jbvSDK/yQ3GoGDB1Ario62b.png" width="370" height="102" /></a>_number is just executed with no checks!
Here is the same snippet from the new BIS_fnc_parseNumberSafe:
<a href="https://ss.lystic.zip/Legacy/k3H8LLE3/LERbFV4SEf6NfH0T.png" target="_blank" rel="noopener noreferrer"><img class="alignnone size-medium" src="https://ss.lystic.zip/Legacy/k3H8LLE3/LERbFV4SEf6NfH0T.png" width="1105" height="141" /></a>

This is a bit more complex. It is using some SQF functionality that I rarely use. Breaking it down, the string stored in _this is first checked if it contains any contents not allowed. If any content is found that is not allowed, _res gets the value of 0. If _res has a value, it will not execute the text. First, let's figure out what is and is not allowed:
<a href="https://ss.lystic.zip/Legacy/SqPg4Mq4/qljgatbSU2KhiQ2E.png" target="_blank" rel="noopener noreferrer"><img class="alignnone size-medium" src="https://ss.lystic.zip/Legacy/SqPg4Mq4/qljgatbSU2KhiQ2E.png" width="1048" height="120" /></a>

So, in theory, if the text contains any code not defined in this list, it will not execute. Testing that out with <em>["hint 'test';0"] call BIS_fnc_parseNumberSafe;</em> we can see that it does do it's job. It does that job well.

Continuing with our analysis, we can find other locations in BIS_fnc_parseNumberSafe that also executes <em>call compile</em>:
<a href="https://ss.lystic.zip/Legacy/CcvScUcx/2Ky3FapmiXwQUKdm.png" target="_blank" rel="noopener noreferrer"><img class="alignnone size-medium" src="https://ss.lystic.zip/Legacy/CcvScUcx/2Ky3FapmiXwQUKdm.png" width="458" height="235" /></a><a href="https://ss.lystic.zip/Legacy/5erkoPvv/5egNBUDTYAZaniwC.png" target="_blank" rel="noopener noreferrer"><img class="alignnone size-medium" src="https://ss.lystic.zip/Legacy/5erkoPvv/5egNBUDTYAZaniwC.png" width="759" height="275" /></a>Looking at these, if the text value comes from a config entry, it will execute it without question.

This begs us to ask, can we find a config entry to execute, that is also exploitable. To find this config entry it needs to satisfy all the following:
<ol>
 	<li>The config is Text or an Array of Text</li>
 	<li>The text is compilable SQF</li>
 	<li>The sqf code executed contains some method of arbitrary execution</li>
</ol>
I quickly created a script to scan the config for entries that could satisfy these items. Sadly, I lost the code, but I saved the data I dumped. Here is the raw dump from the config of possible exploitable config entries: <a href="https://haste.lystic.dev/tasilatiku.pl" target="_blank" rel="noopener noreferrer">https://haste.lystic.dev/tasilatiku.pl</a>.

All of these options execute some function or variable. Now, I need to see if any of these functions have exploits, or if any of these variables are undefined. Luckily, there is one that stand out due to the large number of config entries it was contained in.
<strong>BIS_HC_path_menu <em>
configFile &gt;&gt; "RscHCWPSpeedMode" &gt;&gt; "items" &gt;&gt; "Full" &gt;&gt; "Params" &gt;&gt; "expression"</em></strong>
This config entry contains an arbitrary execution, BIS_HC_path_menu is not defined.

Okay, now we have our arbitrary execution entry in the config file. We need to test our exploit on BIS_fnc_parseNumberSafe. Here is the quick test I ran:
<a href="https://ss.lystic.zip/Legacy/xj4Nz7hy/Nh4iXUPow9nBX7lp.png" target="_blank" rel="noopener noreferrer"><img class="alignnone size-medium" src="https://ss.lystic.zip/Legacy/xj4Nz7hy/Nh4iXUPow9nBX7lp.png" width="891" height="82" /></a>

This worked! Our code is executed! Sweet. Now we need to find a way to use this vulnerability to execute SQF code.

There is a nice old exploit that I never made a post about. This is the Layout exploit. When the player modifies their Layout through the game options, there is a nice little execution opportunity. The position of the HUD elements need to be saved into the profile, and are often parsed with parseNumber. I checked the script RscDisplayOptionsLayout.sqf found in the UI_F.pbo
Here is the code I found that was interesting:
<a href="https://ss.lystic.zip/Legacy/TidnbxI0/B4R8KVg0PHKymBpt.png" target="_blank" rel="noopener noreferrer"><img class="alignnone size-medium" src="https://ss.lystic.zip/Legacy/TidnbxI0/B4R8KVg0PHKymBpt.png" width="598" height="909" /></a>
If the variables for posX, Y, W, H are non-nil and the presetName is not an empty string, the values of posX, Y, W, H are all run through parseNumberSafe. This is good. If we can set the value of these in the UINamespace, we could use this section of code to trigger parseNumberSafe. Digging deeper, this code is executed when the layout is "applied" through the Okay button.

So easy enough, but what should the preset name be? To figure this out, I dug through CfgUIGrids. You can do so yourself, but I will tell you, the only preset name that is valid is "Arma3" for both categories "IGUI" and "GUI". With this knowledge, we should set the variable for both of these categories to the value Arma3.
With that done, we can recreate the foreach loops above, and instead of reading from the uiNamespace variables, we can write to them. We write our exploitable config path, and the parseNumberSafe function should run our code.
<a href="https://ss.lystic.zip/Legacy/0wymzZpP/7NQgn8dFCFliwkbR.png" target="_blank" rel="noopener noreferrer"><img class="alignnone size-medium" src="https://ss.lystic.zip/Legacy/0wymzZpP/7NQgn8dFCFliwkbR.png" width="1322" height="520" /></a>

To test this, we run this in the 3DEN editor and click "Options-&gt;Game-&gt;Layout-&gt;Okay-&gt;Okay" to trigger it. Tada! We have just created another SQF execution exploit in Arma 3!

Here is the complete exploit source: <a href="https://haste.lystic.dev/oraqabuwiv.cs" target="_blank" rel="noopener noreferrer">https://haste.lystic.dev/oraqabuwiv.cs</a>

On a more serious note, I have been finding exploits like this since Arma 3 Apex was released. Before then, I never really looked into them. The way BI handles UI positioning, requiring code execution to parse their position properly, is a very insecure way of handling it. The engine should have been provided native capabilities for these math calculations, and not some simple scripted system. It also seemed to be kind of arrogant of them to think that their new parseNumber function was so safe as to actually call the function parseNumberSafe. Honestly, I am willing to bet any SQF developer who is told <em>"Hey there is an exploit in parseNumberSafe"</em> would find this issue in under 10 minutes.

For server owners, I went ahead and created a patch. You should include this inside the client init of your server. As long as this code executes on the client before they can interact with the UI, you will catch anyone abusing the layout exploit. Here is the source code: <a href="https://ss.lystic.zip/Legacy/gb4NDlHa/aofpece6Q2e3I9Qq.png" target="_blank" rel="noopener noreferrer"><img class="alignnone size-medium" src="https://ss.lystic.zip/Legacy/gb4NDlHa/aofpece6Q2e3I9Qq.png" width="542" height="607" /></a>Download: <a href="https://haste.lystic.dev/baxuloqamu.rb" target="_blank" rel="noopener noreferrer">https://haste.lystic.dev/baxuloqamu.rb</a>
For simplicity, banning could be a simple remoteExec call that you have filtered in remoteExec.txt

<strong>Note: this exploit has been patched as of SPOTREP #00094.</strong>