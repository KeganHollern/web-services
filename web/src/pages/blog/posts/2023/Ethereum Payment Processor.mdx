---
title: Ethereum Payment Processor
description: |
    I have been fascinated with the Ethereum ecosystem since the beginning of Defi.
    I continue to see cryptocurrency as a solution to several failure points of the internet...
slug: ethereum-payment-processor
---

# Ethereum Payment Processor

I have been fascinated with the Ethereum ecosystem since the beginning of <a href="https://www.investopedia.com/decentralized-finance-defi-5113835">DeFi</a>. I continue to see cryptocurrency as a solution to several failure points of the internet. One of those is online payments.

Every online startup I've ever run has always had a single serious problem, payment gateways are extremely complex to configure. PayPal was the big one when I was first getting started. Their API used to be somewhat simple, but has grown so complex that I now struggle to integrate it. Stripe, on the other hand, requires a <strong>ton</strong> of tax information to open a store.

So I decided I would just build my own payment processor. I first built it using the Bitcoin network, but opted to migrate to Ethereum thanks to the myriad of tools available.

[insert] <img class="alignnone wp-image-929" src="http://blog.lystic.dev/wp-content/uploads/2022/11/eth-e1669233086572.jpg" alt="" width="1200" height="200" /> [/insert]

How do we approach a payment processor? Lets start with the high level view, how should funds flow from <em>customer</em> to <em>vendor</em>.

[one_third]

<strong>CUSTOMER </strong>

1. Start a transaction
2. Transfer funds to intermediary wallet

[/one_third]

[one_third]

<strong>INTERMEDIARY </strong>

3. Receive funds
4. Forward funds to vendor

[/one_third]

[one_third_last]

<strong>VENDOR </strong>

5. Receive funds
6. Execute post-transaction code

[/one_third_last]

An intermediary wallet is used to accept customer funds. This makes identifying the completion of a deposit extremely easy; we can simply check the balance of the intermediary.

A transaction has 5 states:
<ol>
 	<li>Pending - Waiting for deposit from user</li>
 	<li>Confirming - Waiting for X confirmations on chain</li>
 	<li>Forwarding - Transfer from intermediary to vendor</li>
 	<li>Notifying - Sending vendor a notification</li>
 	<li>Complete</li>
</ol>
This makes it obvious we should treat each transaction as a <a href="https://en.wikipedia.org/wiki/Finite-state_machine">Finite-state Machine</a>.

[insert] <img class="alignnone wp-image-940" src="http://blog.lystic.dev/wp-content/uploads/2022/11/banner.jpg" alt="" width="1200" height="200" /> [/insert]

I want this processor to be easy to integrate. For that, we'll notify vendors of a completed payment via <a href="https://www.redhat.com/en/topics/automation/what-is-a-webhook">Webhooks</a>. So step #4 will send a POST request to a URL hosted by the vendor with information on the transaction.

To enable vendors to pass extra information, much like PayPal and Stripe APIs allow them to, we'll add an arbitrary <em>userdata</em> attribute to transactions which pass through to the webhook.

Mapping out our processors endpoints, we'll have:

http://localhost/buy/&lt;<strong>ProductID</strong>&gt;?data=&lt;<strong>ArbitaryUserData</strong>&gt;
http://localhost/checkout/&lt;<strong>TransactionId</strong>&gt;

The vendors webhook will look something like this:

<em>POST</em> http://localhost/onpurchase
{"product": "<strong>&lt;ProductID&gt;</strong>", "data": <strong>&lt;ArbitraryUserData&gt;</strong>}

The <em>buy</em> page will create a new transaction and forward us to the <em>checkout</em> page. The checkout page will track the state of the transaction. Checkout lets the user know <em>where</em> to send funds, <em>how much</em> to send, and <em>what</em> is the state of that transfer.

[insert] <img class="alignnone wp-image-950 size-full" src="http://blog.lystic.dev/wp-content/uploads/2022/11/go-e1669233921303.jpg" alt="" width="1143" height="200" /> [/insert]

All of this will work for any cryptocurrency, but by using Ethereum we get the benefit of working with <a href="https://github.com/ethereum/go-ethereum">GETH</a>.

The source is quite large, so I only want to point out some key functions. First lets look at the <strong>buy</strong> API:

<script src="https://gist.github.com/KeganHollern/e9c96c74ba887492374f46a732055c47.js"></script>

This:
<ol>
 	<li>Generates a unique intermediary</li>
 	<li>Converts the USD price of the product to <a href="https://www.investopedia.com/terms/w/wei.asp">WEI</a></li>
 	<li>Generates a new transaction expecting WEI to be deposited into the intermediary</li>
 	<li>Redirects the user to the checkout page</li>
</ol>
I also want to take a look at snippets from the state transitions:

<script src="https://gist.github.com/KeganHollern/7e22577e0c8256877feab6d8ad1b3a80.js"></script>

The first few are checking the state of our intermediary wallet's balance. Once funds have reached the intermediary, and the blocks are confirmed, we fire off a notification to the vendor. Once the vendor confirms they've received the notification, we transfer all funds to the vendor's wallet (minus a transaction fee).

So all we need to do is iterate all open transactions periodically and transition them between states.

[status_ok] That's it! It's actually quite simple. [/status_ok]

This doesn't handle the complexities of all eCommerce, but it does provide a simple interface vendors could integrate their system with.

There are some trade-offs made in the design:
<ul>
 	<li>Fees are passed on to the vendor, rather than an additional charge to customers.</li>
 	<li>The processor does not take any cut, so the system is best self hosted by the vendor.</li>
 	<li>Products are stored in a Database, dynamic checkouts are not supported (though could be!)</li>
 	<li>Not simple to add <a href="https://ethereum.org/en/developers/docs/standards/tokens/erc-20/">ERC20</a> token support in checkout</li>
 	<li>Not easy to add support for <a href="https://ethereum.org/en/layer-2/">L2 chains</a>.</li>
</ul>
As a thought exercise: if we wanted to add ERC20 support, we would need to avoid the Ethereum transaction costs associated with paying out the vendor. We could use a Web3 wallet like <a href="https://metamask.io/">Metamask</a> &amp; automate a <a href="https://uniswap.org/">Uniswap</a> transaction to convert user funds to ETH before transferring them to our vendor. With this approach, the gateway could accept <strong>any</strong> Ethereum asset!

Anyway I thought this project was quite fun. I plan several projects around it, so you'll be seeing more of this in the future.